- name: pull-cache
  service: image_builder
  command: ../deployment/pull-cache.sh

- name: build-sdist
  service: image_builder
  command: docker-make --tag dev moldesign_py_build

- name: build_and_pull_images
  service: image_builder
  type: parallel
  steps:
  - name: pull-dependent-images
    command: ../deployment/pull-chemdocker.sh
  - type: serial
    steps:
      - name: build_py3
        command:
             docker-make moldesign_minimal moldesign_complete
             --tag dev --keep-build-tags
             --cache-repo moldesign --cache-tag cache
    steps:
      - name: build_py2
        command:
          docker-make moldesign_minimal_py2 moldesign_complete_py2
             --tag dev --keep-build-tags
             --cache-repo moldesign --cache-tag cache

- name: print_environments
  type: parallel
  services:
   - test_moldesign_complete
   - test_moldesign_complete_py2
   - test_moldesign_minimal
   - test_moldesign_minimal_py2
  steps:
   - command: ../deployment/print_environment.sh

- service: test_moldesign_complete
  name: test_moldesign_complete
  command: deployment/codeship_runtests.sh

- service: test_moldesign_complete_py2
  name: test_moldesign_complete_py2
  command: deployment/codeship_runtests.sh

- service: test_moldesign_minimal
  name: test_moldesign_minimal
  command: deployment/codeship_runtests.sh

- service: test_moldesign_minimal_py2
  name: test_moldesign_minimal_py2
  command: deployment/codeship_runtests.sh

- service: image_builder
  command: docker-make --tag dev moldesign_notebook --cache-repo moldesign --cache-tag cache
  name: build-notebook

- name: push
  service: publisher
  command: deployment/push.sh

- name: publish
  service: publisher
  # matches tags that are valid PEP440 versions
  tag: '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)((a|rc|b)(0|[1-9]\d*))?$'
  command: deployment/publish.sh

