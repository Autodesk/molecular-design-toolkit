- name: pull-cache
  service: image_builder
  command: deployment/pull-cache.sh

- name: build-sdist
  service: image_builder
  command: docker-make moldesign_py_build
            --keep-build-tags
            -f DockerMakefiles/DockerMake.yml --tag dev

- name: build_and_pull_images
  service: image_builder
  type: parallel
  steps:
  - name: pull-dependent-images
    command: deployment/pull-chemdocker.sh
  - name: build_py3
    command:
         docker-make moldesign_minimal moldesign_complete moldesign_notebook
          -f DockerMakefiles/DockerMake.yml
          --tag dev --keep-build-tags
          --cache-repo moldesign --cache-tag cache
  - name: build_py2
    command:
        docker-make moldesign_minimal_py2 moldesign_complete_py2
         -f DockerMakefiles/DockerMake.yml
         --tag dev --keep-build-tags
         --cache-repo moldesign --cache-tag cache

- name: push_images
  service: image_builder
  command: deployment/push.sh

- name: print_environments
  type: serial
  services:
    - test_moldesign_complete
    - test_moldesign_complete_py2
    - test_moldesign_minimal
    - test_moldesign_minimal_py2
  steps:
   - command: deployment/print_environment.sh

- name: run_tests
  type: serial
  services:
   - test_moldesign_complete
   - test_moldesign_complete_py2
   - test_moldesign_minimal_py2
   - test_moldesign_minimal
  steps:
   - command: deployment/codeship_runtests.sh

- name: publish_python
  service: publisher
  # matches tags that are valid PEP440 versions
  tag: '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)((a|rc|b)(0|[1-9]\d*))?$'
  command: deployment/publish.sh

