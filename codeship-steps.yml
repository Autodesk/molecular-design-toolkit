# Pull previous builds from DockerHub to use as a cache.
# These images are tagged as [imagename]-cache
- name: pull-cache
  service: image_builder
  command: deployment/pull-cache.sh

# Build the python package to be tested (and uploaded to PyPI if this is a release)
# The package is built in the "autodesk/moldesign:moldesign_py_build-[branch name]" image
- name: build-sdist
  service: image_builder
  command: bash -c "docker-make moldesign_py_build
            --repo ${REPO} --tag ${CI_BRANCH}
            --keep-build-tags
            -f DockerMakefiles/DockerMake.yml"

# Build docker images for all test environments. They will be tagged as
# autodesk/moldesign:[imagename]-[branchname]
# (For the sake of parallelism, we also download other images that the tests depend on)
- name: build-and-pull-images
  service: image_builder
  type: parallel
  steps:
  - name: pull-dependent-images
    command: deployment/pull-chemdocker.sh
  - name: build_py3
    command: bash -c
          "docker-make moldesign_minimal moldesign_complete
          -f DockerMakefiles/DockerMake.yml
          --repo ${REPO} --tag ${CI_BRANCH}
           --keep-build-tags
          --cache-repo moldesign --cache-tag cache"
  - name: build_py2
    command: bash -c
         "docker-make moldesign_minimal_py2 moldesign_complete_py2
         -f DockerMakefiles/DockerMake.yml
         --repo ${REPO} --tag ${CI_BRANCH}
         --keep-build-tags
         --cache-repo moldesign --cache-tag cache"


# Push build artifacts to Dockerhub.
# These are tagged as autodesk/moldesign:[imagename]-[branchame]-devbuild
- name: push-images
  type: parallel
  steps:
    - name: push-artifacts
      command: deployment/push.sh moldesign_minimal moldesign_py2 moldesign_py_build
                                  moldesign_complete moldesign_complete_py2
      service: publisher
    - type: serial
      name: make-notebook
      steps:
        - name: build-notebook
          service: image_builder
          command: bash -c
              "docker-make moldesign_notebook
              -f DockerMakefiles/DockerMake.yml
              --repo ${REPO} --tag ${CI_BRANCH}
              --cache-tag cache"
        - name: push-notebook
          service: publisher
          command: deployment/push.sh moldesign_notebook


# Prints out internal information about the test environments
- name: print-environments
  type: parallel
  services:
    - test_moldesign_complete
    - test_moldesign_complete_py2
    - test_moldesign_minimal
    - test_moldesign_minimal_py2
  steps:
   - command: deployment/print-environment.sh
     name: env-report

# Run the tests in each environment.
- name: run-tests
  type: serial
  services:
   - test_moldesign_complete
   - test_moldesign_complete_py2
   - test_moldesign_minimal_py2
   - test_moldesign_minimal
  steps:
   - command: deployment/run-ci-tests.sh
     name: testrunner

# If this build is tagged with a PEP440-compliant version number AND the tests have passed,
# upload the package to PyPI, and push the docker images to dockerhub as
# autodesk/moldesign:[imagename]-[version-number]
- name: publish-python
  service: publisher
  # matches tags that are valid PEP440 versions
  tag: '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)((a|rc|b)(0|[1-9]\d*))?$'
  command: deployment/publish.sh

