

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>moldesign.viewer.viewer3d &mdash; Molecular Design Toolkit 0.7.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Molecular Design Toolkit 0.7.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../contents.html" class="icon icon-home"> Molecular Design Toolkit
          

          
          </a>

          
            
            
              <div class="version">
                0.7.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howdoi.html">How do I ...?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../structure.html">Atoms, molecules, and biomolecules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_moldesign_api/moldesign.html">Complete API reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../contents.html">Molecular Design Toolkit</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../contents.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>moldesign.viewer.viewer3d</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for moldesign.viewer.viewer3d</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2016 Autodesk Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">IPython.display</span> <span class="kn">as</span> <span class="nn">dsp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">moldesign</span> <span class="kn">as</span> <span class="nn">mdt</span>
<span class="kn">from</span> <span class="nn">moldesign</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">moldesign</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">moldesign.helpers</span> <span class="kn">import</span> <span class="n">VolumetricGrid</span><span class="p">,</span> <span class="n">colormap</span>
<span class="kn">from</span> <span class="nn">nbmolviz.drivers3d</span> <span class="kn">import</span> <span class="n">MolViz_3DMol</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">toplevel</span><span class="p">,</span> <span class="n">ColorMixin</span>


<span class="c1"># Right now hard-coded to use 3DMol driver - will need to be configurable when there&#39;s more than one</span>
<span class="c1"># In theory, the only tie to the specific driver should be the class that we inherit from</span>
<span class="nd">@toplevel</span>
<div class="viewcode-block" id="GeometryViewer"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer">[docs]</a><span class="k">class</span> <span class="nc">GeometryViewer</span><span class="p">(</span><span class="n">MolViz_3DMol</span><span class="p">,</span> <span class="n">ColorMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Viewer for static and multiple-frame geometries</span>

<span class="sd">    :ivar mol: Buckyball molecule</span>
<span class="sd">    :type mol: moldesign.Molecule.molecule</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DISTANCE_UNITS</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span>
    <span class="n">HIGHLIGHT_COLOR</span> <span class="o">=</span> <span class="s1">&#39;#1FF3FE&#39;</span>
    <span class="n">DEFAULT_COLOR_MAP</span> <span class="o">=</span> <span class="n">colormap</span>
    <span class="n">DEFAULT_WIDTH</span> <span class="o">=</span> <span class="mi">625</span>
    <span class="n">DEFAULT_HEIGHT</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">DEF_PADDING</span> <span class="o">=</span> <span class="mf">1.75</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;prevent these from being pickled for now&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">make_none</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: make clickable atoms work with trajectories</span>
<span class="sd">        TODO: coloring methods</span>

<span class="sd">        Args:</span>
<span class="sd">            mol (moldesign.AtomContainer): Atoms to visualize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_HEIGHT</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFAULT_WIDTH</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeometryViewer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_click_callback</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_click</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_group</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_change_callback</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_orbitals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">mol</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_molecule</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_frame_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">autostyle</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span> <span class="n">dsp</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wfn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfns</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">]</span>

<div class="viewcode-block" id="GeometryViewer.autostyle"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.autostyle">[docs]</a>    <span class="k">def</span> <span class="nf">autostyle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">mass</span> <span class="o">&lt;=</span> <span class="mf">500.0</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">dalton</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stick</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cartoon_atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line_atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">stick_atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">biochains</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span> <span class="s1">&#39;dna&#39;</span><span class="p">,</span> <span class="s1">&#39;rna&#39;</span><span class="p">):</span>
                    <span class="n">biochains</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;protein&#39;</span><span class="p">:</span>
                    <span class="n">cartoon_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="s1">&#39;solvent&#39;</span><span class="p">):</span>
                    <span class="n">line_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dna&#39;</span><span class="p">,</span> <span class="s1">&#39;rna&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">cartoon_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># includes DNA, RNA if molecule is small enough</span>
                    <span class="n">stick_atoms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cartoon_atoms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cartoon</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">cartoon_atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">biochains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">color_by</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">cartoon_atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">color_by</span><span class="p">(</span><span class="s1">&#39;residue.resname&#39;</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">cartoon_atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line_atoms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">line_atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stick_atoms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stick</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">stick_atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c1"># Deal with unbonded atoms (they only show up in VDW rep)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">numatoms</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="k">print</span> <span class="s1">&#39;WARN: large structure; waters not shown by default.&#39;</span>
            <span class="n">lone</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">num_bonds</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;water&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hide</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">num_bonds</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                             <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_unbonded</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.show_unbonded"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.show_unbonded">[docs]</a>    <span class="k">def</span> <span class="nf">show_unbonded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">lone</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">num_bonds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lone</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdw</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">lone</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_atoms_to_json</span><span class="p">(</span><span class="n">atomlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">atomlist</span><span class="p">,</span> <span class="s1">&#39;iteratoms&#39;</span><span class="p">):</span>
            <span class="n">idxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atomlist</span><span class="o">.</span><span class="n">iteratoms</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: verify that these are actually atoms and not something else with a .index</span>
            <span class="n">idxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atomlist</span><span class="p">]</span>
        <span class="n">atomsel</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">idxes</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">atomsel</span>

    <span class="k">def</span> <span class="nf">_set_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends bond structure to the drawing software</span>
<span class="sd">        This is necessary for formats like PDB, where the bond structure is set implicitly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">nbrs</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_graph</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                          <span class="s1">&#39;nbr&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nbrs</span><span class="p">],</span>
                          <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">bond_graph</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nbrs</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="p">(</span><span class="s1">&#39;setBonds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">bonds</span><span class="p">])</span>

    <span class="nd">@utils.doc_inherit</span>
<div class="viewcode-block" id="GeometryViewer.set_color"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.set_color">[docs]</a>    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_store</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_store</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">if_not_none</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeometryViewer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">)</span></div>

    <span class="nd">@utils.doc_inherit</span>
<div class="viewcode-block" id="GeometryViewer.set_colors"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer.set_colors">[docs]</a>    <span class="k">def</span> <span class="nf">set_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_store</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_store</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">color</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">colormap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeometryViewer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">set_colors</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>

    <span class="nd">@utils.doc_inherit</span>
<div class="viewcode-block" id="GeometryViewer.unset_color"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.unset_color">[docs]</a>    <span class="k">def</span> <span class="nf">unset_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">_store</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_store</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">if_not_none</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeometryViewer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">unset_color</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="n">atoms</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_redraw_highlights</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="GeometryViewer.get_input_file"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.get_input_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">250</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;sdf&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;pdb&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="s1">&#39;write&#39;</span><span class="p">):</span>
            <span class="n">writemol</span> <span class="o">=</span> <span class="n">mdt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writemol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span>
        <span class="n">instring</span> <span class="o">=</span> <span class="n">writemol</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instring</span><span class="p">,</span> <span class="n">fmt</span></div>

<div class="viewcode-block" id="GeometryViewer.get_positions"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.get_positions">[docs]</a>    <span class="k">def</span> <span class="nf">get_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">value_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISTANCE_UNITS</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">positions</span></div>

<div class="viewcode-block" id="GeometryViewer.calc_orb_grid"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer.calc_orb_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calc_orb_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orbname</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">framenum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate orbitals on a grid</span>

<span class="sd">        Args:</span>
<span class="sd">            orbname: Either orbital index (for canonical orbitals) or a tuple ( [orbital type],</span>
<span class="sd">               [orbital index] ) where [orbital type] is a keyword (e.g., canonical, natural, nbo,</span>
<span class="sd">               ao, etc)</span>
<span class="sd">            npts (int): resolution in each dimension of the grid</span>
<span class="sd">            framenum (int): wavefunction for which frame number?</span>

<span class="sd">        Returns:</span>
<span class="sd">            moldesign.viewer.VolumetricGrid: orbital values on a grid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># NEWFEATURE: limit grid size based on the non-zero atomic centers. Useful for localized</span>
        <span class="c1">#    orbitals, which otherwise require high resolution</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">orbtype</span><span class="p">,</span> <span class="n">orbidx</span> <span class="o">=</span> <span class="n">orbname</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">orbtype</span> <span class="o">=</span> <span class="s1">&#39;canonical&#39;</span>
            <span class="n">orbidx</span> <span class="o">=</span> <span class="n">orbname</span>

        <span class="c1"># self.wfn should already be set to the wfn for the current frame</span>
        <span class="n">orbital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfns</span><span class="p">[</span><span class="n">framenum</span><span class="p">]</span><span class="o">.</span><span class="n">orbitals</span><span class="p">[</span><span class="n">orbtype</span><span class="p">][</span><span class="n">orbidx</span><span class="p">]</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frame_positions</span><span class="p">[</span><span class="n">framenum</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">VolumetricGrid</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DEF_PADDING</span><span class="p">,</span>
                              <span class="n">npoints</span><span class="o">=</span><span class="n">npts</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">xyzlist</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">npoints</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">orbital</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">fxyz</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
        <span class="n">maxrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">xr</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">yr</span><span class="p">,</span> <span class="n">grid</span><span class="o">.</span><span class="n">zr</span><span class="p">))</span>

        <span class="c1"># try not to clip the orbitals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="p">(</span><span class="s1">&#39;adjustClipping&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.6</span><span class="o">*</span> <span class="n">maxrange</span><span class="o">.</span><span class="n">value_in</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">grid</span></div>

<div class="viewcode-block" id="GeometryViewer.get_orbnames"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.get_orbnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_orbnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.draw_atom_vectors"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer.draw_atom_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">draw_atom_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vecs</span><span class="p">,</span> <span class="n">rescale_to</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span>
                          <span class="n">scale_factor</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
                          <span class="n">radius</span><span class="o">=</span><span class="mf">0.11</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For displaying atom-centered vector data (e.g., momenta, forces)</span>
<span class="sd">        :param rescale_to: rescale to this length (in angstroms) (not used if scale_factor is passed)</span>
<span class="sd">        :param scale_factor: Scaling factor for arrows: dimensions of [vecs dimensions] / [length]</span>
<span class="sd">        :param render: render immediately</span>
<span class="sd">        :param kwargs: keyword arguments for self.draw_arrow</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;opacity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opacity</span>
        <span class="k">if</span> <span class="n">vecs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">ndims</span><span class="p">,):</span>
            <span class="n">vecs</span> <span class="o">=</span> <span class="n">vecs</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">vecs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">num_atoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;`vecs` must be a num_atoms X 3 matrix or&#39;</span> \
                                                      <span class="s1">&#39; 3*num_atoms vector&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="s2">&quot;Input vectors are 0.&quot;</span>

        <span class="c1"># strip units and scale the vectors appropriately</span>
        <span class="k">if</span> <span class="n">scale_factor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># scale all arrows by this quantity</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">get_units</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span><span class="o">/</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">:</span>  <span class="c1"># allow implicit scale factor</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">DISTANCE_UNITS</span>

            <span class="n">vecarray</span> <span class="o">=</span> <span class="n">vecs</span> <span class="o">/</span> <span class="n">scale_factor</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">arrowvecs</span> <span class="o">=</span> <span class="n">vecarray</span><span class="o">.</span><span class="n">value_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISTANCE_UNITS</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="n">arrowvecs</span> <span class="o">=</span> <span class="n">vecarray</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># rescale the maximum length arrow length to rescale_to</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vecarray</span> <span class="o">=</span> <span class="n">vecs</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">vecs</span><span class="o">.</span><span class="n">getunits</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">vecarray</span> <span class="o">=</span> <span class="n">vecs</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">vecarray</span> <span class="o">*</span> <span class="n">vecarray</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">lengths</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">rescale_to</span><span class="p">)</span>  <span class="c1"># units of [vec units] / angstrom</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="s1">&#39;defunits&#39;</span><span class="p">):</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="o">.</span><span class="n">defunits</span><span class="p">()</span>
            <span class="n">arrowvecs</span> <span class="o">=</span> <span class="n">vecarray</span> <span class="o">/</span> <span class="n">scale</span>
            <span class="k">print</span> <span class="s1">&#39;Arrow scale: {q:.3f} {unit} per {native}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                                                                    <span class="n">native</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DISTANCE_UNITS</span><span class="p">)</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">vecarray</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">arrowvecs</span><span class="p">):</span>
            <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">draw_arrow</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">vecarray</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="GeometryViewer.draw_axis"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.draw_axis">[docs]</a>    <span class="k">def</span> <span class="nf">draw_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">label_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">on</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">xarrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_arrow</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_label</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_kwargs</span><span class="p">)</span>
            <span class="n">yarrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_arrow</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_label</span><span class="p">([</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_kwargs</span><span class="p">)</span>
            <span class="n">zarrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_arrow</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">zlabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_label</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">label_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">xarrow</span><span class="p">,</span> <span class="n">yarrow</span><span class="p">,</span> <span class="n">zarrow</span><span class="p">,</span>
                                  <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">zlabel</span><span class="p">]</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">on</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">arrow</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">arrow</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axis_objects</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.draw_forces"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.draw_forces">[docs]</a>    <span class="k">def</span> <span class="nf">draw_forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_atom_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryViewer.draw_momenta"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.draw_momenta">[docs]</a>    <span class="k">def</span> <span class="nf">draw_momenta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_atom_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">momenta</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryViewer.highlight_atoms"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer.highlight_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">highlight_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            atoms (list[Atoms]): list of atoms to highlight. If None, remove all highlights</span>
<span class="sd">            render (bool): render this change immediately</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: Need to handle style changes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span><span class="p">:</span>  <span class="c1"># first, unhighlight old highlights</span>
            <span class="n">to_unset</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="n">atom</span><span class="p">],</span>
                                                            <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_colored_as</span><span class="p">[</span><span class="n">atom</span><span class="p">],</span>
                                                            <span class="n">_store</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                            <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">to_unset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">to_unset</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unset_color</span><span class="p">(</span><span class="n">to_unset</span><span class="p">,</span> <span class="n">_store</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">if_not_none</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_redraw_highlights</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="n">render</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_redraw_highlights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HIGHLIGHT_COLOR</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_highlights</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_store</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<div class="viewcode-block" id="GeometryViewer.label_atoms"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.label_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">label_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;render&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">atoms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_label</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.add_click_callback"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.add_click_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_click_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryViewer.remove_click_callback"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.remove_click_callback">[docs]</a>    <span class="k">def</span> <span class="nf">remove_click_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryViewer.handle_click"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.handle_click">[docs]</a>    <span class="k">def</span> <span class="nf">handle_click</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trait_name</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="c1"># TODO: this should handle more than just atoms</span>
        <span class="n">atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">new</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selection_group</span><span class="o">.</span><span class="n">update_selections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;atoms&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">atom</span><span class="p">]})</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeometryViewer.append_frame"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.append_frame">[docs]</a>    <span class="k">def</span> <span class="nf">append_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># override base method - we&#39;ll handle frames entirely in python</span>
        <span class="c1"># this is copied verbatim from molviz, except for the line noted</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>

        <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_units</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frame_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>  <span class="c1"># only modification from molviz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

    <span class="nd">@utils.doc_inherit</span>
<div class="viewcode-block" id="GeometryViewer.show_frame"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.show_frame">[docs]</a>    <span class="k">def</span> <span class="nf">show_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framenum</span><span class="p">,</span> <span class="n">_fire_event</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">update_orbitals</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c1"># override base method - we&#39;ll handle frames using self.set_positions</span>
        <span class="c1"># instead of any built-in handlers</span>
        <span class="k">if</span> <span class="n">framenum</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_frame_positions</span><span class="p">[</span><span class="n">framenum</span><span class="p">],</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_frame</span> <span class="o">=</span> <span class="n">framenum</span>
            <span class="k">if</span> <span class="n">_fire_event</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_group</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selection_group</span><span class="o">.</span><span class="n">update_selections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;framenum&#39;</span><span class="p">:</span> <span class="n">framenum</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">update_orbitals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redraw_orbs</span><span class="p">(</span><span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.handle_selection_event"><a class="viewcode-back" href="../../../toplevel.html#moldesign.GeometryViewer.handle_selection_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_selection_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deals with an external selection event</span>
<span class="sd">        :param selection:todo</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orb_changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s1">&#39;atoms&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">highlight_atoms</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s1">&#39;atoms&#39;</span><span class="p">],</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;framenum&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_change_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frame_change_callback</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s1">&#39;framenum&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_frame</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s1">&#39;framenum&#39;</span><span class="p">],</span>
                            <span class="n">_fire_event</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">update_orbitals</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                            <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">orb_changed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;orbname&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s1">&#39;orbname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_orbital</span><span class="p">):</span>
            <span class="n">orb_changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_orbital</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;orbname&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;orbital_isovalue&#39;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;orbital_isovalue&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbital_spec</span><span class="p">[</span><span class="s1">&#39;isoval&#39;</span><span class="p">]):</span>
            <span class="n">orb_changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbital_spec</span><span class="p">[</span><span class="s1">&#39;isoval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="s1">&#39;orbital_isovalue&#39;</span><span class="p">]</span>

        <span class="c1"># redraw the orbital if necessary</span>
        <span class="k">if</span> <span class="n">orb_changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redraw_orbs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

<div class="viewcode-block" id="GeometryViewer.redraw_orbs"><a class="viewcode-back" href="../../../_moldesign_api/moldesign.viewer.html#moldesign.GeometryViewer.redraw_orbs">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_orbs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbital_is_selected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_orbital</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_orbital</span><span class="p">,</span> <span class="n">render</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">orbital_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">render</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">orbital_is_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_orbital</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_orbital</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_convert_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">value_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DISTANCE_UNITS</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 Autodesk Research.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.7.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>